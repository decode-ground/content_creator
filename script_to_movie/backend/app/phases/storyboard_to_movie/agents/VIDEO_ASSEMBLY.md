# Final Video Assembly

## What it does

`assemble_final_movie(db, project_id)` is the last step of Phase 3. It takes all the individual scene videos that were already generated by the upstream agents and concatenates them into a single MP4 file.

For each scene (in order):
1. Downloads the generated video clip from its URL
2. If the scene has dialogue, generates TTS audio with gTTS and merges it into the video using ffmpeg
3. Collects the clip for final concatenation

Then it:
4. Writes a `clips.txt` file and runs `ffmpeg -f concat` to produce `final_movie.mp4`
5. Uploads to S3 (falls back to local `media/` directory if S3 is unavailable)
6. Creates a `FinalMovie` DB record and sets `project.status = "completed"`, `project.progress = 100`

## How it fits into Phase 3

Phase 3 runs three steps in sequence via `service.run_phase()`:

```
1. VideoPromptAgent    -->  generates optimized text prompts per scene
2. VideoGenerationAgent -->  sends prompts + storyboard images to Kling AI, gets video clips
3. assemble_final_movie -->  TTS + concat all clips into one movie  <-- this function
```

The service layer calls it like this:

```python
# service.py
from app.phases.storyboard_to_movie.agents.video_assembly import assemble_final_movie

async def run_video_assembly(db, project_id):
    return await assemble_final_movie(db, project_id)
```

It's also exposed as an API endpoint:

```
POST /api/phases/storyboard-to-movie/{project_id}/assemble
```

## Prerequisites

- **ffmpeg** must be installed (`brew install ffmpeg`)
- **gTTS** must be installed (already in `pyproject.toml`)
- Scenes must exist in DB with `GeneratedVideo` records in `status="completed"`

## Return value

```python
{
    "status": "success",
    "message": "Assembled 5 clips into final movie",
    "clips_assembled": 5,
    "total_duration": 40,
    "movie_url": "https://bucket.s3.amazonaws.com/projects/1/final_movie.mp4"
}
```

On failure it returns `{"status": "error", "message": "..."}` without raising.
